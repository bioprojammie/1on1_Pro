<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>1對1 教學管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        canvas { touch-action: none; display: block; width: 100%; height: 100%; cursor: crosshair; background-color: #ffffff; }
        .canvas-box { border: 2px dashed #cbd5e1; border-radius: 12px; overflow: hidden; position: relative; background: white; width: 100%; }
        .paint-canvas { background-color: transparent !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tag { display: inline-flex; align-items: center; background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin-right: 4px; margin-bottom: 4px; font-weight: bold; border: 1px solid #dbeafe; }
        .record-card { transition: all 0.2s; border-left: 5px solid transparent; }
        .record-card:active { transform: scale(0.99); }
        .record-card.status-planned { border-left-color: #fbbf24; background: white; }
        .record-card.status-done { border-left-color: #22c55e; background: #f0fdf4; }
        .img-scroller { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
        .img-thumb { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; flex-shrink: 0; background: white; }
        .cal-card { background: white; border-left: 3px solid #6366f1; padding: 6px; margin-bottom: 6px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.8rem; cursor: pointer; transition: transform 0.1s; }
        .sig-box { border: 2px dashed #cbd5e1; border-radius: 12px; height: 100%; min-height: 100px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: white; transition: all 0.2s; }
        .sig-box:active { background: #f8fafc; border-color: #94a3b8; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-gray-800 w-full">

    <nav class="bg-white shadow-sm z-20 flex-none h-16 flex items-center justify-between px-4">
        <div class="font-bold text-xl text-indigo-600 flex items-center gap-2 select-none">
            <i class="fa-solid fa-chalkboard-user"></i> 1對1 教學系統
        </div>
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
            <button onclick="switchTab('page-list')" id="nav-list" class="px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition">總表</button>
            <button onclick="switchTab('page-create')" id="nav-create" class="px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition">建檔</button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 w-full max-w-6xl mx-auto no-scrollbar pb-24">

        <div id="page-create" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm max-w-2xl mx-auto space-y-5">
                <h2 class="text-lg font-bold border-b pb-2 text-gray-700">建立學生檔案</h2>
                <input type="text" id="cName" placeholder="學生姓名" class="w-full p-4 border rounded-xl bg-gray-50 text-lg">
                <input type="number" id="cCredits" placeholder="初始堂數" class="w-full p-4 border rounded-xl bg-gray-50 text-lg">
                <input type="text" id="cBody" placeholder="狀況備註 (如: 身體狀況/學習目標)" class="w-full p-4 border rounded-xl">
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <label class="font-bold text-blue-600 text-xs block mb-2">預設固定上課時間</label>
                    <div class="flex gap-2 mb-2 items-center">
                        <select id="schDay" class="p-3 rounded-lg border bg-white flex-1 font-bold text-gray-700"><option value="週一">週一</option><option value="週二">週二</option><option value="週三">週三</option><option value="週四">週四</option><option value="週五">週五</option><option value="週六">週六</option><option value="週日">週日</option></select>
                        <select id="schHour" class="p-3 rounded-lg border bg-white font-mono font-bold"><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option></select>
                        <span class="font-bold text-gray-400">:</span>
                        <select id="schMin" class="p-3 rounded-lg border bg-white font-mono font-bold"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select>
                        <button onclick="addScheduleTag()" class="bg-blue-600 text-white px-4 py-3 rounded-lg font-bold">加入</button>
                    </div>
                    <div id="scheduleTags" class="min-h-[30px] flex flex-wrap"></div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><label class="font-bold text-indigo-600 text-xs block mb-2">1. 上傳合約</label><input type="file" id="cContractFile" accept="image/*" class="w-full text-sm"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl border"><div class="flex justify-between mb-1"><label class="font-bold text-gray-400 text-xs">2. 學生簽名</label><button onclick="clearPad('padNewContractStudent')" class="text-xs text-red-400">清除</button></div><div class="canvas-box h-32"><canvas id="padNewContractStudent"></canvas></div></div>
                    <div class="bg-gray-50 p-4 rounded-xl border"><div class="flex justify-between mb-1"><label class="font-bold text-gray-400 text-xs">3. 老師/教練簽名</label><button onclick="clearPad('padNewContractTeacher')" class="text-xs text-red-400">清除</button></div><div class="canvas-box h-32"><canvas id="padNewContractTeacher"></canvas></div></div>
                </div>
                <button onclick="createStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">完成建檔</button>
            </div>
        </div>

        <div id="page-list" class="">
            <div class="bg-white rounded-2xl shadow-sm mb-6 overflow-hidden border border-gray-100">
                <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center"><h3 class="font-bold text-indigo-800"><i class="fa-regular fa-calendar-days"></i> 本週課表</h3></div>
                <div class="overflow-x-auto pb-2"><div class="grid grid-cols-7 min-w-[800px] divide-x divide-gray-100 text-center" id="calendarGrid"></div></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-h-[40vh]">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-500 text-sm uppercase"><tr><th class="p-4 w-1/4">姓名</th><th class="p-4 w-1/3">固定時間</th><th class="p-4">剩餘堂數</th><th class="p-4 text-right">操作</th></tr></thead>
                    <tbody id="studentListBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div class="mt-8 p-6 bg-gray-100 rounded-2xl border border-gray-200 text-center">
                <button onclick="backupData()" class="bg-white border text-gray-700 px-4 py-2 rounded-lg text-sm mr-2"><i class="fa-solid fa-download"></i> 備份</button>
                <label class="bg-white border text-gray-700 px-4 py-2 rounded-lg text-sm cursor-pointer"><i class="fa-solid fa-upload"></i> 還原<input type="file" id="importFile" accept=".json" class="hidden" onchange="restoreData(this)"></label>
                <div class="mt-4"><button onclick="clearAllSystem()" class="text-xs text-red-300 underline">清除重置</button></div>
            </div>
        </div>

        <div id="page-detail" class="hidden">
            <button onclick="switchTab('page-list')" class="text-gray-500 font-bold flex items-center gap-1 bg-white px-3 py-2 rounded-lg shadow-sm mb-4 w-fit"><i class="fa-solid fa-chevron-left"></i> 返回總表</button>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-1"><h2 id="dName" class="text-3xl font-bold text-gray-800"></h2><button onclick="openProfileModal()" class="text-gray-400 hover:text-indigo-600"><i class="fa-solid fa-gear fa-lg"></i></button><button onclick="viewContract()" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded ml-2">合約</button></div>
                    <div id="dSchedule" class="flex flex-wrap gap-1 mt-1"></div><p id="dBody" class="text-xs text-red-500 font-bold mt-2 bg-red-50 inline-block px-2 py-1 rounded border border-red-100"></p>
                </div>
                <div class="bg-indigo-600 rounded-xl p-4 text-white shadow-md flex items-center gap-6 min-w-[200px] justify-between w-full md:w-auto">
                    <div><p class="text-indigo-200 text-xs font-bold uppercase">剩餘堂數</p><p id="dCredits" class="text-4xl font-mono font-bold leading-none">0</p></div>
                    <button onclick="openRenewModal()" class="bg-white text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-50 transition active:scale-95 whitespace-nowrap"><i class="fa-solid fa-plus"></i> 購課/續約</button>
                </div>
            </div>
            <div class="max-w-4xl mx-auto">
                <button onclick="addNewRecord()" class="w-full bg-white border-2 border-dashed border-indigo-200 text-indigo-600 py-4 rounded-2xl font-bold text-lg hover:bg-indigo-50 transition mb-6 shadow-sm"><i class="fa-solid fa-plus-circle"></i> 預排新課程</button>
                <div id="timeline" class="space-y-4 pb-20"></div>
            </div>
        </div>
    </main>

    <div id="profileModal" class="fixed inset-0 z-50 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl"><h3 class="font-bold text-xl mb-4 border-b pb-2">編輯學生資料</h3><div class="space-y-4"><div><label class="text-xs text-gray-500 font-bold">姓名</label><input type="text" id="pName" class="w-full p-3 border rounded-xl bg-gray-50"></div><div><label class="text-xs text-gray-500 font-bold">狀況備註</label><input type="text" id="pBody" class="w-full p-3 border rounded-xl bg-gray-50"></div><div class="bg-blue-50 p-3 rounded-xl border border-blue-100"><label class="text-xs font-bold text-blue-600 mb-2 block">固定上課時間</label><div class="flex gap-1 mb-2"><select id="pDay" class="p-2 rounded border bg-white flex-1 text-sm"><option value="週一">週一</option><option value="週二">週二</option><option value="週三">週三</option><option value="週四">週四</option><option value="週五">週五</option><option value="週六">週六</option><option value="週日">週日</option></select><select id="pHour" class="p-2 rounded border bg-white text-sm font-mono"><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option></select><select id="pMin" class="p-2 rounded border bg-white text-sm font-mono"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select><button onclick="addProfileScheduleTag()" class="bg-blue-600 text-white px-3 rounded font-bold text-sm">＋</button></div><div id="profileScheduleTags" class="min-h-[30px] flex flex-wrap gap-1"></div></div></div><div class="flex gap-3 mt-6"><button onclick="document.getElementById('profileModal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">取消</button><button onclick="saveProfile()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">儲存變更</button></div></div></div>
    <div id="contentModal" class="fixed inset-0 z-40 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-lg p-5 rounded-2xl shadow-2xl h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg">編輯課程內容</h3><button onclick="closeContentModal()" class="text-gray-400"><i class="fa-solid fa-xmark fa-xl"></i></button></div><div class="flex-1 overflow-y-auto space-y-4"><textarea id="modalEditNote" rows="5" placeholder="輸入課程筆記..." class="w-full p-3 rounded-xl bg-gray-50 text-base border focus:ring-2 focus:ring-blue-200"></textarea><div class="font-bold text-gray-500 text-sm">照片紀錄</div><div class="flex gap-2 overflow-x-auto pb-2 min-h-[110px]" id="modalImgList"></div><label class="block w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-center text-gray-400 font-bold cursor-pointer hover:bg-gray-50"><i class="fa-solid fa-images"></i> 點此上傳照片<input type="file" id="modalFileInput" accept="image/*" multiple class="hidden" onchange="handleModalAddImage(this)"></label></div><div class="mt-4 pt-2 border-t"><button onclick="saveModalContent()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">儲存內容</button></div></div></div>
    <div id="signModal" class="fixed inset-0 z-40 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md p-5 rounded-2xl shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">學生簽到</h3><button onclick="clearPad('padSignModal')" class="text-xs text-red-500 font-bold">清除重簽</button></div><div class="canvas-box h-48 bg-gray-50 mb-4"><canvas id="padSignModal"></canvas></div><div class="flex gap-3"><button onclick="closeSignModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">取消</button><button onclick="confirmSignModal()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg">確認 (扣1堂)</button></div></div></div>
    <div id="paintModal" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col"><div class="flex justify-between items-center p-4 bg-gray-800 text-white safe-top"><button onclick="closePaintModal()" class="px-4 py-2 text-gray-300 font-bold hover:text-white">取消</button><h3 class="font-bold">圖片標註</h3><button onclick="savePaint()" class="px-4 py-2 bg-indigo-500 rounded-lg font-bold shadow hover:bg-indigo-600">完成</button></div><div class="flex-1 relative bg-black flex items-center justify-center overflow-hidden" id="paintContainer"><canvas id="canvasPaint" class="paint-canvas"></canvas></div><div class="p-6 bg-gray-800 flex justify-center gap-6 safe-bottom"><button onclick="setPen('#ef4444')" class="w-12 h-12 rounded-full bg-red-500 border-4 border-gray-700 ring-2 ring-white hover:scale-110 transition"></button><button onclick="setPen('#facc15')" class="w-12 h-12 rounded-full bg-yellow-400 border-4 border-gray-700 hover:scale-110 transition"></button><button onclick="setPen('#3b82f6')" class="w-12 h-12 rounded-full bg-blue-500 border-4 border-gray-700 hover:scale-110 transition"></button><button onclick="setPen('#22c55e')" class="w-12 h-12 rounded-full bg-green-500 border-4 border-gray-700 hover:scale-110 transition"></button></div></div>
    <div id="renewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm"><div class="bg-white w-[90%] max-w-lg p-6 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-200" id="renewContent"><h3 class="text-xl font-bold mb-4 text-center">購買 / 續約</h3><div class="space-y-4"><input type="number" id="renewAmount" class="w-full p-4 border rounded-2xl text-2xl font-bold text-center outline-none focus:ring-2 focus:ring-indigo-500" placeholder="輸入堂數"><div class="grid grid-cols-2 gap-3"><div class="bg-gray-50 p-2 rounded-xl border"><div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">學生簽名</label><button onclick="clearPad('padRenewStudent')" class="text-xs text-red-400">清除</button></div><div class="canvas-box h-24 bg-white"><canvas id="padRenewStudent"></canvas></div></div><div class="bg-gray-50 p-2 rounded-xl border"><div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">老師簽名</label><button onclick="clearPad('padRenewTeacher')" class="text-xs text-red-400">清除</button></div><div class="canvas-box h-24 bg-white"><canvas id="padRenewTeacher"></canvas></div></div></div><div class="flex gap-3 mt-2"><button onclick="closeRenewModal()" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200">取消</button><button onclick="submitRenew()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700">確認購買</button></div></div></div></div>
    <div id="contractModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center p-4" onclick="this.classList.add('hidden')"><div class="bg-white p-4 rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">合約與簽名詳情</h3><button onclick="document.getElementById('contractModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button></div><div id="contractContent" class="space-y-4"></div></div></div>

    <script>
        // --- 核心改動：通用化與自動遷移 ---
        const CUR_VER = 'tms_v1'; // Generic Key
        const OLD_VER = 'p93';    // Previous Key

        function loadAndUpgradeData() {
            let st = localStorage.getItem(CUR_VER + '_st');
            let rc = localStorage.getItem(CUR_VER + '_rc');
            if (st && rc) return { students: JSON.parse(st), records: JSON.parse(rc) };

            // Migration from p93
            let oldSt = localStorage.getItem(OLD_VER + '_st');
            let oldRc = localStorage.getItem(OLD_VER + '_rc');
            
            // Fallback: Check p92 if p93 is missing (double safety)
            if (!oldSt) {
                oldSt = localStorage.getItem('p92_st');
                oldRc = localStorage.getItem('p92_rc');
            }

            if (oldSt && oldRc) {
                console.log(`Migrating to ${CUR_VER}...`);
                let sList = JSON.parse(oldSt);
                let rList = JSON.parse(oldRc);
                localStorage.setItem(CUR_VER + '_st', JSON.stringify(sList));
                localStorage.setItem(CUR_VER + '_rc', JSON.stringify(rList));
                return { students: sList, records: rList };
            }
            return { students: [], records: [] };
        }

        const data = loadAndUpgradeData();
        let students = data.students;
        let records = data.records;
        
        let curSid = null, editRecId = null;
        let tempSchedule = [], tempProfileSchedule = [];
        let tempEditorImages = [];
        let paintImgIndex = -1;
        let paintBaseImg = null;
        const pads = {};

        function compressImage(src, maxWidth=800, quality=0.6) { return new Promise((resolve) => { if(!src) resolve(null); const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height = Math.round((height *= maxWidth / width)); width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,width,height); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.src = src; }); }
        function fileToDataURL(file) { return new Promise((resolve) => { if(!file) resolve(null); const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.readAsDataURL(file); }); }
        function getTimeString() { return new Date().toLocaleString('zh-TW', { hour12: false }); }

        function initPad(id, isSig=false) {
            const canvas = document.getElementById(id); if(!canvas) return; const parent = canvas.parentElement; if(parent.offsetWidth === 0) return;
            const resize = () => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = parent.clientWidth * ratio; canvas.height = parent.clientHeight * ratio;
                canvas.style.width = parent.clientWidth + "px"; canvas.style.height = parent.clientHeight + "px";
                const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio); ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                if(id !== 'canvasPaint') { ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width/ratio, canvas.height/ratio); }
                if(id === 'canvasPaint' && paintBaseImg) drawImageFit(paintBaseImg, canvas, ctx, parent.clientWidth, parent.clientHeight);
            };
            new ResizeObserver(resize).observe(parent); resize();
            const ctx = canvas.getContext('2d'); let isDrawing = false;
            const getPos = (e) => { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; };
            const start = (e) => { if(e.cancelable && e.type.includes('touch')) e.preventDefault(); isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); };
            const move = (e) => { if(!isDrawing) return; if(e.cancelable && e.type.includes('touch')) e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.strokeStyle = isSig ? '#1f2937' : (pads.color||'#ef4444'); ctx.lineWidth = isSig ? 2 : 4; ctx.stroke(); };
            const end = () => isDrawing=false;
            canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseout', end);
            pads[id] = {c: canvas, ctx: ctx};
        }

        function switchTab(id) { ['page-create', 'page-list', 'page-detail'].forEach(p => document.getElementById(p).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id === 'page-create') requestAnimationFrame(() => { initPad('padNewContractStudent', true); initPad('padNewContractTeacher', true); }); if(id === 'page-list') renderList(); }
        function addScheduleTag() { const day=document.getElementById('schDay').value, hour=document.getElementById('schHour').value, min=document.getElementById('schMin').value, tag=`${day} ${hour}:${min}`; if(!tempSchedule.includes(tag)){tempSchedule.push(tag); renderTempTags();} }
        function renderTempTags() { document.getElementById('scheduleTags').innerHTML = tempSchedule.map(t => `<span class="tag cursor-pointer hover:bg-red-100 hover:text-red-500" onclick="removeTag('${t}')">${t} <i class="fa-solid fa-xmark ml-1"></i></span>`).join(''); }
        function removeTag(t) { tempSchedule = tempSchedule.filter(x => x !== t); renderTempTags(); }
        
        function openProfileModal() { const s = students.find(x => x.id === curSid); document.getElementById('pName').value = s.name; document.getElementById('pBody').value = s.body; tempProfileSchedule = [...(s.schedule || [])]; renderProfileTags(); document.getElementById('profileModal').classList.remove('hidden'); }
        function addProfileScheduleTag() { const day=document.getElementById('pDay').value, hour=document.getElementById('pHour').value, min=document.getElementById('pMin').value, tag=`${day} ${hour}:${min}`; if(!tempProfileSchedule.includes(tag)){tempProfileSchedule.push(tag); renderProfileTags();} }
        function renderProfileTags() { document.getElementById('profileScheduleTags').innerHTML = tempProfileSchedule.map(t => `<span class="tag cursor-pointer hover:bg-red-100 hover:text-red-500" onclick="removeProfileTag('${t}')">${t} <i class="fa-solid fa-xmark ml-1"></i></span>`).join(''); }
        function removeProfileTag(t) { tempProfileSchedule = tempProfileSchedule.filter(x => x !== t); renderProfileTags(); }
        function saveProfile() { const idx = students.findIndex(x => x.id === curSid); if(idx > -1) { students[idx].name = document.getElementById('pName').value; students[idx].body = document.getElementById('pBody').value; students[idx].schedule = [...tempProfileSchedule]; save(); openDetail(curSid); document.getElementById('profileModal').classList.add('hidden'); } }

        function backupData() { const d = { students, records, version: "Generic_v1", date: new Date().toISOString() }; const b = new Blob([JSON.stringify(d)], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `teaching_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); alert("已下載備份檔"); }
        function restoreData(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); if (d.students && d.records && confirm("還原將覆蓋目前資料，確定？")) { localStorage.setItem(CUR_VER + '_st', JSON.stringify(d.students)); localStorage.setItem(CUR_VER + '_rc', JSON.stringify(d.records)); alert("還原成功"); location.reload(); } } catch (err) { alert("檔案錯誤"); } }; r.readAsText(f); }
        function clearAllSystem() { if(confirm("清除所有資料無法復原，確定？")) { localStorage.clear(); location.reload(); } }

        async function createStudent() {
            const name=document.getElementById('cName').value, credits=document.getElementById('cCredits').value, body=document.getElementById('cBody').value, fileInput=document.getElementById('cContractFile');
            if(!name || !credits) return alert("請輸入完整資料");
            const sigStudent = await compressImage(pads['padNewContractStudent'].c.toDataURL(), 500, 0.5);
            const sigTeacher = await compressImage(pads['padNewContractTeacher'].c.toDataURL(), 500, 0.5);
            let contractImg = null; if(fileInput.files && fileInput.files[0]) { contractImg = await compressImage(await fileToDataURL(fileInput.files[0]), 1024, 0.7); }
            students.push({ id: Date.now(), name, credits: parseInt(credits), body: body||"無", contractSigStudent: sigStudent, contractSigTeacher: sigTeacher, contractImg: contractImg, schedule: [...tempSchedule], contractDate: getTimeString() });
            save(); document.getElementById('cName').value=''; document.getElementById('cCredits').value=''; fileInput.value = ''; tempSchedule = []; renderTempTags(); clearPad('padNewContractStudent'); clearPad('padNewContractTeacher'); switchTab('page-list');
        }

        function addNewRecord() { const newRec = { id: Date.now(), sid: curSid, date: getTimeString(), type: 'class', status: 'planned', note: '', imgs: [], sig: null }; records.unshift(newRec); save(); renderTimeline(); }

        function renderTimeline() {
            const t = document.getElementById('timeline'); const my = records.filter(r => r.sid === curSid); t.innerHTML = my.length ? '' : '<p class="text-center text-gray-300 py-6">尚無課程，點擊上方按鈕預排</p>';
            my.forEach(r => {
                const div = document.createElement('div'); div.className = "record-card shadow-sm rounded-2xl mb-4 p-4 border border-gray-100 relative";
                if (r.type === 'renew') {
                    div.style.borderLeftColor = '#6366f1'; div.innerHTML = `<div class="flex justify-between font-bold text-indigo-800"><span><i class="fa-solid fa-receipt"></i> 購買紀錄</span><span>+${r.amount}</span></div><div class="text-right text-xs text-indigo-400 mt-1">${r.date}</div>`;
                } else {
                    const isDone = r.status === 'done'; div.className += isDone ? " status-done" : " status-planned";
                    const metaHtml = `<div class="md:col-span-2 col-span-12 flex md:flex-col justify-between md:justify-start gap-2 border-b md:border-b-0 md:border-r border-gray-100 pb-2 md:pb-0 md:pr-4"><div><div class="font-bold text-gray-700">${r.date.split(' ')[0]}</div><div class="text-xs text-gray-400 mb-2">${r.date.split(' ')[1]}</div>${isDone ? '<span class="text-green-600 text-xs font-bold bg-green-100 px-2 py-1 rounded">已簽到</span>' : '<span class="text-yellow-600 text-xs font-bold bg-yellow-100 px-2 py-1 rounded">預排中</span>'}</div><button onclick="openContentModal(${r.id})" class="text-blue-500 bg-blue-50 px-3 py-2 rounded-xl text-sm font-bold hover:bg-blue-100 flex items-center justify-center gap-1"><i class="fa-solid fa-pen"></i> 編輯</button></div>`;
                    const imgsHtml = (r.imgs && r.imgs.length > 0) ? `<div class="img-scroller mt-2" onclick="openContentModal(${r.id})">${r.imgs.map(src=>`<img src="${src}" class="img-thumb">`).join('')}</div>` : `<div class="mt-2 text-xs text-gray-300 italic p-2 border border-dashed rounded text-center cursor-pointer" onclick="openContentModal(${r.id})">點此新增照片</div>`;
                    const contentHtml = `<div class="md:col-span-7 col-span-12 px-2 py-2 md:py-0"><p class="text-sm text-gray-700 whitespace-pre-wrap">${r.note || '<span class="text-gray-300">點擊編輯按鈕新增筆記...</span>'}</p>${imgsHtml}</div>`;
                    let actionHtml = isDone ? `<div class="md:col-span-3 col-span-12 flex flex-col items-center justify-center border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-4"><img src="${r.sig}" class="h-16 object-contain"><span class="text-[10px] text-green-600 font-bold mt-1">✓ 已扣課確認</span></div>` : `<div class="md:col-span-3 col-span-12 flex items-center justify-center border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-4"><div onclick="openSignModal(${r.id})" class="sig-box w-full hover:bg-green-50 hover:border-green-300 group"><div class="text-center group-hover:text-green-600 text-gray-400"><i class="fa-solid fa-pen-nib text-xl mb-1"></i><div class="text-xs font-bold">點此簽名</div></div></div></div>`;
                    div.innerHTML = `<div class="grid grid-cols-12 gap-2 h-full">${metaHtml}${contentHtml}${actionHtml}</div>`;
                }
                t.appendChild(div);
            });
        }

        function openContentModal(rid) { editRecId = rid; const r = records.find(x => x.id === rid); document.getElementById('modalEditNote').value = r.note || ''; tempEditorImages = [...(r.imgs || [])]; renderModalImgList(); document.getElementById('contentModal').classList.remove('hidden'); }
        function closeContentModal() { document.getElementById('contentModal').classList.add('hidden'); }
        function renderModalImgList() { document.getElementById('modalImgList').innerHTML = tempEditorImages.map((src, idx) => `<img src="${src}" class="img-thumb flex-none" onclick="openPaintModal(${idx})">`).join(''); }
        function handleModalAddImage(input) { if(input.files) { Array.from(input.files).forEach(file => { const r = new FileReader(); r.onload = async (e) => { const compressed = await compressImage(e.target.result, 800, 0.6); tempEditorImages.push(compressed); renderModalImgList(); }; r.readAsDataURL(file); }); } }
        function saveModalContent() { const idx = records.findIndex(r => r.id === editRecId); if (idx > -1) { records[idx].note = document.getElementById('modalEditNote').value; records[idx].imgs = [...tempEditorImages]; save(); renderTimeline(); closeContentModal(); } }
        function openPaintModal(idx) { paintImgIndex = idx; document.getElementById('paintModal').classList.remove('hidden'); paintBaseImg = new Image(); paintBaseImg.onload = () => initPad('canvasPaint'); paintBaseImg.src = tempEditorImages[idx]; }
        function savePaint() { (async () => { const d = await compressImage(pads['canvasPaint'].c.toDataURL(), 800, 0.6); tempEditorImages[paintImgIndex] = d; renderModalImgList(); closePaintModal(); })(); }
        function closePaintModal() { document.getElementById('paintModal').classList.add('hidden'); }
        function drawImageFit(img, c, ctx, cw, ch) { const r=Math.min(cw/img.width,ch/img.height),w=img.width*r,h=img.height*r,x=(cw-w)/2,y=(ch-h)/2; ctx.clearRect(0,0,cw,ch); ctx.drawImage(img,0,0,img.width,img.height,x,y,w,h); }
        function setPen(c) { pads.color=c; }

        let signingRecId = null;
        function openSignModal(rid) { signingRecId = rid; document.getElementById('signModal').classList.remove('hidden'); setTimeout(() => initPad('padSignModal'), 50); }
        function closeSignModal() { document.getElementById('signModal').classList.add('hidden'); clearPad('padSignModal'); }
        async function confirmSignModal() {
            const idx = records.findIndex(r => r.id === signingRecId);
            if (idx > -1) {
                const s = students.find(x => x.id === curSid);
                if (s.credits <= 0) return alert("堂數不足，無法簽到！");
                const sig = await compressImage(pads['padSignModal'].c.toDataURL(), 400, 0.5);
                s.credits--; records[idx].status = 'done'; records[idx].sig = sig; records[idx].date = getTimeString();
                save(); document.getElementById('dCredits').innerText = s.credits; renderTimeline(); closeSignModal(); alert("簽到成功！已扣除 1 堂課");
            }
        }

        function renderList() {
            const tbody = document.getElementById('studentListBody'); tbody.innerHTML = '';
            students.forEach(s => {
                const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50 active:bg-gray-100 transition cursor-pointer hover-effect"; tr.onclick = (e) => { if(e.target.closest('button')) return; openDetail(s.id); };
                const timeHtml = s.schedule && s.schedule.length > 0 ? s.schedule.map(t => `<span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mr-1 mb-1 font-bold">${t}</span>`).join('') : '<span class="text-xs text-gray-300">無</span>';
                tr.innerHTML = `<td class="p-4 font-bold text-gray-800 text-lg">${s.name}</td><td class="p-4 align-top">${timeHtml}</td><td class="p-4 font-mono font-bold text-xl ${s.credits<2?'text-red-500':'text-indigo-600'}">${s.credits}</td><td class="p-4 text-right"><button onclick="openDetail(${s.id})" class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-full shadow-sm hover:bg-indigo-100 transition flex items-center justify-center ml-auto"><i class="fa-solid fa-chevron-right"></i></button></td>`;
                tbody.appendChild(tr);
            });
            renderCalendar();
        }
        function renderCalendar() { const days = ['週一','週二','週三','週四','週五','週六','週日']; const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; days.forEach(day => { let classes = []; students.forEach(s => { if(s.schedule) s.schedule.forEach(timeStr => { if(timeStr.startsWith(day)) classes.push({ time: timeStr.split(' ')[1], name: s.name, sid: s.id }); }); }); classes.sort((a,b) => a.time.localeCompare(b.time)); const col = document.createElement('div'); col.className = "p-2 min-h-[150px]"; let cardsHtml = classes.map(c => `<div class="cal-card" onclick="openDetail(${c.sid})"><div class="font-bold text-indigo-600">${c.time}</div><div class="truncate text-gray-700 font-bold">${c.name}</div></div>`).join(''); if(classes.length === 0) cardsHtml = '<div class="text-xs text-gray-300 mt-4">-</div>'; col.innerHTML = `<div class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide sticky top-0 bg-white py-1 z-10">${day}</div>${cardsHtml}`; grid.appendChild(col); }); }
        function openDetail(sid) { try { curSid = sid; const s = students.find(x=>x.id===sid); document.getElementById('dName').innerText = s.name; document.getElementById('dCredits').innerText = s.credits; document.getElementById('dBody').innerText = s.body; document.getElementById('dSchedule').innerHTML = s.schedule && s.schedule.length ? s.schedule.map(t => `<span class="tag">${t}</span>`).join('') : '<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">未設定時間</span>'; renderTimeline(); switchTab('page-detail'); } catch(e) { console.error(e); } }
        function viewContract() { const s = students.find(x=>x.id===curSid); const c = document.getElementById('contractContent'); c.innerHTML = ''; if(s.contractImg) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">合約照片:</p><img src="${s.contractImg}" class="w-full rounded border"></div>`; if(s.contractSigStudent) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">學生簽名:</p><img src="${s.contractSigStudent}" class="w-full rounded border bg-gray-50 h-24 object-contain"></div>`; if(s.contractSigTeacher) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">老師簽名:</p><img src="${s.contractSigTeacher}" class="w-full rounded border bg-gray-50 h-24 object-contain"></div>`; if(s.contractDate) c.innerHTML += `<div class="text-right text-xs text-gray-400 mt-2">簽署日期: ${s.contractDate}</div>`; document.getElementById('contractModal').classList.remove('hidden'); }
        function openRenewModal() { const m = document.getElementById('renewModal'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); document.getElementById('renewContent').classList.remove('scale-95'); }, 10); setTimeout(() => { initPad('padRenewStudent', true); initPad('padRenewTeacher', true); }, 100); }
        function closeRenewModal() { const m = document.getElementById('renewModal'); m.classList.add('opacity-0'); document.getElementById('renewContent').classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }
        async function submitRenew() { const amt = parseInt(document.getElementById('renewAmount').value); if(!amt) return alert("請輸入堂數"); const sigStu = await compressImage(pads['padRenewStudent'].c.toDataURL(), 500, 0.5); const sigTea = await compressImage(pads['padRenewTeacher'].c.toDataURL(), 500, 0.5); const time = getTimeString(); const s = students.find(x=>x.id===curSid); s.credits += amt; records.unshift({ id: Date.now(), sid: curSid, date: time, type: 'renew', amount: amt, sigStudent: sigStu, sigTeacher: sigTea }); save(); document.getElementById('dCredits').innerText = s.credits; document.getElementById('renewAmount').value = ''; clearPad('padRenewStudent'); clearPad('padRenewTeacher'); closeRenewModal(); renderTimeline(); }
        function clearPad(id) { const p = pads[id]; if(!p) return; p.ctx.clearRect(0,0,p.c.width,p.c.height); if(id!=='canvasPaint'){ p.ctx.fillStyle='#ffffff'; p.ctx.fillRect(0,0,p.c.width,p.c.height); } }
        function save() { localStorage.setItem(CUR_VER + '_st',JSON.stringify(students)); localStorage.setItem(CUR_VER + '_rc',JSON.stringify(records)); }
        
        switchTab('page-list');
    </script>
</body>
</html>
